<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>CVE Map — Aggregated GitHub Exploits Dashboard</title>
  <meta name="description" content="Real-time intelligence dashboard tracking CVE exploits and Proofs-of-Concept across GitHub repositories."/>

  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#06b6d4",
            "primary-glow": "rgba(6,182,212,0.4)",
            "bg-dark": "#0f1115",
            "surface": "#161b22",
            "surface-2": "#1f2937",
            "border": "#30363d",
            "dim": "#8b949e",
            "success": "#2ea043",
            "warning": "#d29922",
            "danger": "#f85149",
          },
          fontFamily: {
            mono: ['JetBrains Mono', 'monospace'],
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <style>
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #0d1117; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #484f58; }

    .glass {
      background: rgba(22,27,34,0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(48,54,61,0.7);
    }
    .cve-row { cursor: pointer; transition: background 0.12s, border-color 0.12s; }
    .cve-row:hover { background: rgba(31,41,55,0.9); }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
  </style>
</head>

<body class="dark bg-bg-dark text-gray-200 font-sans antialiased h-screen flex flex-col overflow-hidden">

<!-- ===== HEADER ===== -->
<header class="h-14 border-b border-border flex items-center justify-between px-5 bg-surface shrink-0 z-20">
  <div class="flex items-center gap-2">
    <span class="material-symbols-outlined text-primary text-2xl">radar</span>
    <h1 class="font-mono font-bold text-lg tracking-tight text-white">
      CVE <span class="text-primary">MAP</span>
    </h1>
    <span class="text-[10px] ml-1 px-2 py-0.5 rounded-full bg-surface-2 text-dim hidden sm:inline">
      Aggregated GitHub Exploits &amp; PoCs Dashboard
    </span>
  </div>
  <div class="flex items-center gap-3">
    <div class="relative hidden md:block">
      <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-500 text-sm">search</span>
      <input id="search-input"
        class="bg-surface-2 border border-border focus:border-primary focus:ring-1 focus:ring-primary rounded pl-8 pr-3 py-1.5 text-xs text-white placeholder-gray-500 w-56 transition-all outline-none"
        placeholder="Search CVEs or Repositories..." type="text"/>
    </div>
    <a id="api-link" href="data/2026.json" target="_blank"
      class="flex items-center gap-1.5 px-2.5 py-1.5 rounded border border-border text-xs font-medium hover:bg-surface-2 transition-colors text-gray-300">
      <span class="material-symbols-outlined text-sm">terminal</span>
      Public API JSON
    </a>
    <div class="h-7 w-7 rounded-full bg-gradient-to-tr from-primary to-purple-500 flex items-center justify-center text-white font-bold text-[10px]">JS</div>
  </div>
</header>

<!-- ===== LAYOUT ===== -->
<div class="flex flex-1 overflow-hidden">

  <!-- LEFT SIDEBAR -->
  <aside class="w-56 bg-surface border-r border-border overflow-y-auto shrink-0 p-4 gap-5 z-10 hidden lg:flex flex-col">

    <!-- Year Timeline -->
    <div>
      <h3 class="text-[10px] font-semibold uppercase tracking-wider text-dim mb-2.5 flex items-center gap-1.5">
        <span class="material-symbols-outlined text-sm">calendar_month</span> Explore Timeline
      </h3>
      <div id="year-grid" class="grid grid-cols-3 gap-1.5"></div>
    </div>

    <hr class="border-border"/>

    <!-- NVD Severity Guide -->
    <div>
      <h3 class="text-[10px] font-semibold uppercase tracking-wider text-dim mb-2.5 flex items-center gap-1.5">
        <span class="material-symbols-outlined text-sm">security</span> NVD Intelligence
      </h3>
      <div class="space-y-1.5">
        <div class="flex items-center justify-between text-xs p-2 rounded bg-red-500/10 border border-red-900/30">
          <span class="text-gray-300 font-medium">Critical</span>
          <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-danger text-white">9.0 - 10.0</span>
        </div>
        <div class="flex items-center justify-between text-xs p-2 rounded bg-orange-500/10 border border-orange-900/30">
          <span class="text-gray-300 font-medium">High</span>
          <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-orange-500 text-white">7.0 - 8.9</span>
        </div>
        <div class="flex items-center justify-between text-xs p-2 rounded bg-yellow-500/10 border border-yellow-900/30">
          <span class="text-gray-300 font-medium">Medium</span>
          <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-warning text-white">4.0 - 6.9</span>
        </div>
        <div class="flex items-center justify-between text-xs p-2 rounded bg-green-500/10 border border-green-900/30">
          <span class="text-gray-300 font-medium">Low</span>
          <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-success text-white">0.1 - 3.9</span>
        </div>
      </div>
    </div>

    <hr class="border-border"/>

    <!-- Severity Donut -->
    <div class="mt-auto">
      <h3 class="text-[10px] font-semibold uppercase tracking-wider text-dim mb-2">Severity Distribution</h3>
      <div class="h-36 relative">
        <canvas id="severityChart"></canvas>
        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
          <span id="sev-total" class="font-mono font-bold text-sm text-white">—</span>
          <span class="text-[9px] text-dim">CVEs</span>
        </div>
      </div>
      <div class="mt-2 grid grid-cols-2 gap-x-2 gap-y-1 text-[9px] text-dim">
        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-danger inline-block"></span>Critical</div>
        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-orange-500 inline-block"></span>High</div>
        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-warning inline-block"></span>Medium</div>
        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-sm bg-gray-600 inline-block"></span>Unscored</div>
      </div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 overflow-y-auto bg-bg-dark">
    <div class="p-4 md:p-5 space-y-4 max-w-7xl mx-auto">

      <!-- STATS CARDS -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="glass p-4 rounded-lg border-l-4 border-l-primary flex flex-col gap-1.5 group hover:bg-surface-2/50 transition-all">
          <div class="flex justify-between items-center">
            <h3 class="text-[10px] font-bold uppercase tracking-wider text-dim">Indexed Exploits (Select Year)</h3>
            <span class="material-symbols-outlined text-primary text-lg opacity-50 group-hover:opacity-100 transition">bug_report</span>
          </div>
          <div class="flex items-baseline gap-2">
            <span id="stat-cves" class="text-4xl font-mono font-bold text-white">—</span>
            <span id="stat-cves-sub" class="text-xs text-dim font-mono"></span>
          </div>
        </div>

        <div class="glass p-4 rounded-lg border-l-4 border-l-purple-500 flex flex-col gap-1.5 group hover:bg-surface-2/50 transition-all">
          <div class="flex justify-between items-center">
            <h3 class="text-[10px] font-bold uppercase tracking-wider text-dim">Total Repos Mapped</h3>
            <span class="material-symbols-outlined text-purple-500 text-lg opacity-50 group-hover:opacity-100 transition">folder_data</span>
          </div>
          <div class="flex items-baseline gap-2">
            <span id="stat-repos" class="text-4xl font-mono font-bold text-white">—</span>
            <span id="stat-repos-sub" class="text-xs text-dim font-mono"></span>
          </div>
        </div>

        <div class="glass p-4 rounded-lg border-l-4 border-l-danger flex flex-col gap-2 group hover:bg-surface-2/50 transition-all">
          <div class="flex justify-between items-center">
            <h3 class="text-[10px] font-bold uppercase tracking-wider text-dim">Most Targeted Output</h3>
            <span class="material-symbols-outlined text-danger text-lg opacity-50 group-hover:opacity-100 transition">warning</span>
          </div>
          <span id="stat-top" class="font-mono font-bold text-danger text-xl truncate">—</span>
          <div class="w-full bg-gray-800 h-1 rounded-full overflow-hidden">
            <div class="bg-danger h-full w-3/4"></div>
          </div>
        </div>
      </div>

      <!-- CHARTS ROW -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="lg:col-span-2 glass p-4 rounded-lg">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-bold text-white flex items-center gap-1.5">
              <span class="material-symbols-outlined text-primary text-base">ssid_chart</span>
              <span id="trend-label">Exploit Trends</span>
            </h3>
            <span class="text-[10px] px-2 py-0.5 rounded bg-surface-2 text-dim border border-border">By Month</span>
          </div>
          <div class="h-40 w-full">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <div class="glass p-4 rounded-lg flex flex-col h-full">
          <div class="flex items-center justify-between mb-3 pb-2 border-b border-border/50">
            <h4 class="text-xs font-bold text-white flex items-center gap-2">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
              </span>
              Recent Exploit Activity
            </h4>
            <span class="text-[10px] text-dim uppercase tracking-wider font-mono">Live</span>
          </div>
          <div id="activity-feed" class="flex-1 overflow-y-auto space-y-3 pr-1 max-h-52">
            <div class="text-center py-4 text-dim text-xs">Loading activity...</div>
          </div>
        </div>
      </div>

      <!-- CVE TABLE -->
      <div class="glass rounded-lg overflow-hidden flex flex-col" style="min-height:380px">
        <div class="px-4 py-3 border-b border-border flex items-center justify-between bg-surface-2/30">
          <h2 id="table-title" class="text-sm font-bold text-white flex items-center gap-2">
            <span class="w-1.5 h-5 bg-primary rounded-sm"></span>
            Compiled Exploits &amp; Proofs-of-Concept
          </h2>
          <div class="flex gap-2 items-center">
            <!-- Mobile search -->
            <input id="search-mobile"
              class="md:hidden bg-surface-2 border border-border focus:border-primary rounded px-2 py-1 text-xs text-white placeholder-gray-500 w-36 outline-none"
              placeholder="Search..." type="text"/>
            <span id="result-count" class="text-[10px] text-dim font-mono hidden md:block"></span>
          </div>
        </div>

        <!-- Column headers -->
        <div class="grid grid-cols-12 gap-2 px-4 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider border-b border-border/50 bg-surface-2/20">
          <div class="col-span-5">CVE ID</div>
          <div class="col-span-2 text-center">Type</div>
          <div class="col-span-3 text-right">Activity</div>
          <div class="col-span-2 text-right hidden md:block">Stars</div>
        </div>

        <!-- CVE Rows -->
        <div id="cve-list" class="overflow-y-auto flex-1 divide-y divide-border/25">
          <div class="flex items-center justify-center py-16 text-dim text-sm">
            <span class="material-symbols-outlined spin text-primary mr-2">autorenew</span>
            Loading threat intelligence...
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- RIGHT: NVD DETAIL PANEL -->
  <aside id="nvd-panel"
    class="w-72 bg-surface border-l border-border shrink-0 hidden xl:flex flex-col p-4 gap-4 overflow-y-auto">
    <div class="flex items-center gap-1.5 text-[10px] font-semibold uppercase tracking-wider text-dim">
      <span class="material-symbols-outlined text-sm text-primary">shield</span>
      NVD Intel
    </div>
    <div id="nvd-body">
      <div class="text-center py-10 text-dim flex flex-col items-center gap-2">
        <span class="material-symbols-outlined text-3xl text-border">lock</span>
        <p class="text-xs">Click any CVE to load<br/>intelligence data</p>
      </div>
    </div>
  </aside>

</div><!-- end layout -->

<script>
// ============================================================
// STATE
// ============================================================
let currentData   = null;   // { year, cves: [{cve_id, repositories:[...]}] }
let nvdLayer      = null;   // { "CVE-XXXX-NNNN": { s, v, d } }
let currentYear   = new Date().getFullYear();
let trendChart    = null;
let sevChart      = null;
let searchTimer   = null;
let maxStars      = 1;

// ============================================================
// BOOT
// ============================================================
document.addEventListener('DOMContentLoaded', async () => {
  buildYearGrid();

  // Silently pre-load the NVD proprietary intel dict
  try {
    const r = await fetch('data/nvd_intel.json');
    if (r.ok) nvdLayer = await r.json();
  } catch(_) {}

  await loadYear(currentYear);

  // Wire search inputs
  ['search-input','search-mobile'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', e => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => renderList(e.target.value.trim()), 220);
    });
  });
});

// ============================================================
// YEAR GRID
// ============================================================
function buildYearGrid() {
  const grid = document.getElementById('year-grid');
  const now = new Date().getFullYear();
  const years = [];
  for (let y = now; y >= 2015; y--) years.push(y);
  grid.innerHTML = years.map(y => `
    <button data-y="${y}" onclick="selectYear(${y})"
      class="year-btn px-1.5 py-1 rounded text-[11px] font-mono border transition-all
      ${y === currentYear
        ? 'bg-primary/10 border-primary text-primary'
        : 'bg-surface-2 border-transparent text-gray-400 hover:border-gray-600'}">
      ${y}
    </button>`).join('');
}

function selectYear(y) {
  currentYear = y;
  document.querySelectorAll('.year-btn').forEach(b => {
    const active = +b.dataset.y === y;
    b.className = `year-btn px-1.5 py-1 rounded text-[11px] font-mono border transition-all
      ${active ? 'bg-primary/10 border-primary text-primary' : 'bg-surface-2 border-transparent text-gray-400 hover:border-gray-600'}`;
  });
  loadYear(y);
}

// ============================================================
// LOAD YEAR DATA
// ============================================================
async function loadYear(year) {
  setLoading(`Fetching ${year} threat data...`);
  try {
    const r = await fetch(`data/${year}.json`);
    if (!r.ok) throw new Error('not found');
    currentData = await r.json();
  } catch (_) {
    currentData = null;
    setEmpty(`No exploit data found for ${year}. The scraper may not have run yet for this year.`);
    updateStats(null, year);
    return;
  }
  updateStats(currentData, year);
  renderList('');
  buildTrendChart(currentData, year);
  buildSevChart(currentData);
  buildActivityFeed(currentData);
  document.getElementById('api-link').href = `data/${year}.json`;
}

// ============================================================
// RECENT EXPLOIT ACTIVITY FEED
// ============================================================
function buildActivityFeed(data) {
  const feed = document.getElementById('activity-feed');
  if (!data?.cves) { feed.innerHTML = '<div class="text-center py-4 text-dim text-xs">No data.</div>'; return; }

  // Collect all repos with their CVE ID and sort by pushed_at desc
  const allRepos = [];
  data.cves.forEach(cve => {
    (cve.repositories || []).forEach(r => {
      if (r.pushed_at) allRepos.push({ cveId: cve.cve_id, repo: r });
    });
  });
  allRepos.sort((a,b) => new Date(b.repo.pushed_at) - new Date(a.repo.pushed_at));

  const dotColors = ['bg-primary','bg-purple-500','bg-danger','bg-warning','bg-success','bg-gray-500'];
  const textColors = ['text-primary','text-purple-400','text-danger','text-warning','text-success','text-gray-400'];

  const items = allRepos.slice(0, 7);
  if (!items.length) { feed.innerHTML = '<div class="text-center py-4 text-dim text-xs">No recent activity.</div>'; return; }

  feed.innerHTML = items.map((item, i) => {
    const { cveId, repo } = item;
    const color = dotColors[i % dotColors.length];
    const tcolor = textColors[i % textColors.length];
    const isLast = i === items.length - 1;
    const age = timeAgo(new Date(repo.pushed_at));

    return `
      <div class="flex gap-2.5 group">
        <div class="flex flex-col items-center mt-0.5 shrink-0">
          <div class="w-2 h-2 rounded-full ${color}"></div>
          ${!isLast ? '<div class="w-px flex-1 bg-border/50 mt-1 min-h-[12px]"></div>' : ''}
        </div>
        <div class="pb-2 min-w-0">
          <p class="text-xs text-gray-300 font-mono leading-snug">
            <span class="${tcolor} font-bold">${cveId}</span>
            mapped in <span class="text-white truncate">${repo.full_name}</span>
          </p>
          <span class="text-[10px] text-dim">${age}</span>
        </div>
      </div>`;
  }).join('');
}

function timeAgo(date) {
  const diff = (Date.now() - date.getTime()) / 1000;
  if (diff < 3600)  return Math.round(diff / 60) + ' mins ago';
  if (diff < 86400) return Math.round(diff / 3600) + ' hrs ago';
  if (diff < 604800) return Math.round(diff / 86400) + ' days ago';
  return date.toLocaleDateString('en-US', { month:'short', day:'numeric' });
}

function setLoading(msg) {
  document.getElementById('cve-list').innerHTML = `
    <div class="flex items-center justify-center py-16 text-dim text-sm">
      <span class="material-symbols-outlined spin text-primary mr-2">autorenew</span>${msg}
    </div>`;
}

function setEmpty(msg) {
  document.getElementById('cve-list').innerHTML = `
    <div class="flex flex-col items-center justify-center py-14 text-dim text-sm gap-2">
      <span class="material-symbols-outlined text-2xl">cloud_off</span>
      <p class="text-center max-w-xs">${msg}</p>
    </div>`;
}

// ============================================================
// STATS
// ============================================================
function updateStats(data, year) {
  const el = id => document.getElementById(id); // safe getter

  el('table-title').innerHTML =
    `<span class="w-1.5 h-5 bg-primary rounded-sm inline-block mr-2"></span>
     Compiled Exploits &amp; Proofs-of-Concept (${year})`;
  el('trend-label').textContent = `Exploit Trends (${year})`;

  if (!data?.cves?.length) {
    el('stat-cves').textContent = '0';
    el('stat-repos').textContent = '0';
    el('stat-top').textContent = '—';
    return;
  }

  const cves = data.cves;
  const totalRepos = cves.reduce((s, c) => s + (c.repositories?.length || 0), 0);
  const top = [...cves].sort((a,b) =>
    (b.repositories?.length||0) - (a.repositories?.length||0)
  )[0];

  el('stat-cves').textContent = cves.length.toLocaleString();
  el('stat-repos').textContent = totalRepos.toLocaleString();
  el('stat-top').textContent = top?.cve_id || '—';
}

// ============================================================
// CVE LIST RENDER
// ============================================================
function getType(cveId, repos) {
  const text = [cveId, ...(repos||[]).map(r=>(r.description||'')+(r.full_name||''))].join(' ').toLowerCase();
  if (/\brce\b|remote.?code.?exec|code.?execution/.test(text))
    return ['RCE','bg-red-900/30 text-red-400 border-red-800/50'];
  if (/zero.?day|0day/.test(text))
    return ['Zero-Day','bg-cyan-900/30 text-cyan-400 border-cyan-800/50'];
  if (/\blpe\b|privilege.?escal|local.?privesc/.test(text))
    return ['LPE','bg-yellow-900/30 text-yellow-400 border-yellow-800/50'];
  if (/inject|sqli|\bxss\b|\bssti\b/.test(text))
    return ['Inject','bg-purple-900/30 text-purple-400 border-purple-800/50'];
  if (/\bdos\b|denial.of.service|flood|crash/.test(text))
    return ['DoS','bg-orange-900/30 text-orange-400 border-orange-800/50'];
  if (/bypass|auth.bypass/.test(text))
    return ['Bypass','bg-indigo-900/30 text-indigo-400 border-indigo-800/50'];
  if (/\bpoc\b|proof.of.concept|writeup/.test(text))
    return ['PoC','bg-teal-900/30 text-teal-400 border-teal-800/50'];
  return ['Exploit','bg-blue-900/30 text-blue-400 border-blue-800/50'];
}

function getSevDot(cveId) {
  const s = nvdLayer?.[cveId]?.s || 0;
  if (s >= 9.0) return 'bg-danger shadow-[0_0_6px_rgba(248,81,73,0.7)]';
  if (s >= 7.0) return 'bg-orange-500';
  if (s >= 4.0) return 'bg-warning';
  if (s > 0)    return 'bg-success';
  return 'bg-gray-600';
}

function isNew(repos) {
  const cutoff = Date.now() - 7 * 864e5;
  return (repos||[]).some(r => r.pushed_at && new Date(r.pushed_at).getTime() > cutoff);
}

function renderList(q = '') {
  if (!currentData?.cves) return;
  const query = q.toLowerCase();

  let list = currentData.cves;
  if (query) {
    list = list.filter(c =>
      c.cve_id.toLowerCase().includes(query) ||
      (c.repositories||[]).some(r =>
        (r.full_name||'').toLowerCase().includes(query) ||
        (r.description||'').toLowerCase().includes(query)
      )
    );
  }

  // Sort: total stars desc
  const sorted = [...list].sort((a,b) => {
    const sa = (a.repositories||[]).reduce((s,r)=>s+(r.stargazers_count||0),0);
    const sb = (b.repositories||[]).reduce((s,r)=>s+(r.stargazers_count||0),0);
    return sb - sa;
  });

  maxStars = sorted.length
    ? Math.max(1,(sorted[0].repositories||[]).reduce((s,r)=>s+(r.stargazers_count||0),0))
    : 1;

  document.getElementById('result-count').textContent =
    `${sorted.length.toLocaleString()} result${sorted.length!==1?'s':''}`;

  if (!sorted.length) {
    setEmpty('No CVEs match your search.');
    return;
  }

  document.getElementById('cve-list').innerHTML = sorted.map(cve => {
    const repos   = cve.repositories || [];
    const stars   = repos.reduce((s,r)=>s+(r.stargazers_count||0),0);
    const count   = repos.length;
    const pct     = Math.min(100, Math.round(stars/maxStars*100));
    const [label, cls] = getType(cve.cve_id, repos);
    const dot     = getSevDot(cve.cve_id);
    const newTag  = isNew(repos);
    const hot     = stars >= maxStars * 0.45 && stars > 5;
    const active  = count >= 3;

    const rowBase = hot
      ? 'bg-primary/5 border-l-2 border-l-primary'
      : active ? 'bg-red-900/5 border-l-2 border-l-danger' : '';

    return `<div onclick="showNVD('${cve.cve_id}')"
      class="cve-row grid grid-cols-12 gap-2 px-4 py-2.5 items-center border border-transparent hover:border-border ${rowBase}">

      <div class="col-span-5 flex items-center gap-2 min-w-0">
        <div class="w-1.5 h-1.5 rounded-full shrink-0 ${dot}${active?' pulse':''}"></div>
        <span class="font-mono font-medium text-xs text-white truncate">${cve.cve_id}</span>
        ${newTag ? '<span class="shrink-0 px-1 py-0.5 rounded text-[9px] font-bold bg-gray-700 text-gray-300">New</span>' : ''}
        ${hot ? '<span class="material-symbols-outlined text-[11px] text-primary shrink-0">local_fire_department</span>' : ''}
      </div>

      <div class="col-span-2 text-center">
        <span class="px-1.5 py-0.5 rounded text-[10px] font-medium border ${cls}">${label}</span>
      </div>

      <div class="col-span-3 text-right">
        <span class="text-[11px] text-dim">${count} exploit${count!==1?'s':''} · ★ ${stars.toLocaleString()}</span>
      </div>

      <div class="col-span-2 hidden md:flex items-center">
        <div class="w-full bg-gray-800 rounded-full h-1">
          <div class="h-1 rounded-full ${stars > maxStars*0.7 ? 'bg-danger' : stars > maxStars*0.4 ? 'bg-warning' : 'bg-primary'}" style="width:${pct}%"></div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// NVD DETAIL PANEL
// ============================================================
function showNVD(cveId) {
  const intel = nvdLayer?.[cveId];
  const score = intel?.s || 0;
  const sev   = intel?.v || '';
  const desc  = intel?.d || null;

  let badgeCls = 'bg-gray-700 text-gray-300';
  if (score >= 9.0)      badgeCls = 'bg-danger text-white';
  else if (score >= 7.0) badgeCls = 'bg-orange-500 text-white';
  else if (score >= 4.0) badgeCls = 'bg-warning text-white';
  else if (score > 0)    badgeCls = 'bg-success text-white';

  const cveObj = currentData?.cves?.find(c => c.cve_id === cveId);
  const repos  = (cveObj?.repositories || []).slice(0, 8);

  document.getElementById('nvd-body').innerHTML = `
    <div class="space-y-3">

      <div class="p-3 rounded-lg bg-surface-2 border border-border">
        <div class="font-mono text-xs font-bold text-primary mb-1.5">${cveId}</div>
        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${badgeCls}">
          ${score > 0 ? `CVSS ${score} · ${sev}` : 'UNSCORED'}
        </span>
      </div>

      <div>
        <div class="text-[10px] font-semibold uppercase tracking-wider text-dim mb-1">Description</div>
        <p class="text-xs text-gray-300 leading-relaxed">
          ${desc ||
            '<span class="text-dim italic">Not yet in the local NVD snapshot. Will update on next scraper run.</span>'}
        </p>
      </div>

      <div>
        <div class="text-[10px] font-semibold uppercase tracking-wider text-dim mb-1.5">
          Exploit Repos (${repos.length}${cveObj?.repositories?.length > 8 ? '+' : ''})
        </div>
        <div class="space-y-1.5 max-h-60 overflow-y-auto">
          ${repos.map(r => `
            <a href="${r.html_url}" target="_blank"
              class="flex items-start justify-between gap-2 p-2 rounded bg-surface-2 border border-border hover:border-primary transition-colors group">
              <div class="min-w-0">
                <div class="font-mono text-[10px] text-white truncate group-hover:text-primary transition-colors">
                  ${r.full_name}
                </div>
                <div class="text-[9px] text-dim truncate mt-0.5">${r.description || 'No description'}</div>
              </div>
              <div class="text-[9px] text-dim shrink-0">★ ${(r.stargazers_count||0).toLocaleString()}</div>
            </a>`).join('')}
        </div>
      </div>

      <a href="https://nvd.nist.gov/vuln/detail/${cveId}" target="_blank"
        class="flex items-center justify-center gap-1.5 w-full py-2 text-[10px] font-bold text-primary
               hover:text-white border border-primary hover:bg-primary rounded transition-all uppercase tracking-wide">
        <span class="material-symbols-outlined text-sm">open_in_new</span>
        View on NIST NVD
      </a>
    </div>`;
}

// ============================================================
// TREND CHART (from real pushed_at timestamps)
// ============================================================
function buildTrendChart(data, year) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const counts = new Array(12).fill(0);

  (data?.cves || []).forEach(cve => {
    (cve.repositories || []).forEach(r => {
      if (r.pushed_at) {
        const d = new Date(r.pushed_at);
        if (d.getFullYear() === year) counts[d.getMonth()]++;
      }
    });
  });

  const now = new Date();
  const lastIdx = (year < now.getFullYear()) ? 11 : now.getMonth();
  const labels = months.slice(0, lastIdx + 1);
  const values = counts.slice(0, lastIdx + 1);

  if (trendChart) trendChart.destroy();
  const ctx = document.getElementById('trendChart').getContext('2d');
  const grad = ctx.createLinearGradient(0, 0, 0, 200);
  grad.addColorStop(0, 'rgba(6,182,212,0.45)');
  grad.addColorStop(1, 'rgba(6,182,212,0.0)');

  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Exploit Repos',
        data: values,
        borderColor: '#06b6d4',
        backgroundColor: grad,
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#0f1115',
        pointBorderColor: '#06b6d4',
        pointBorderWidth: 2,
        pointRadius: 3,
        pointHoverRadius: 5,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(22,27,34,0.95)',
          titleColor: '#fff', bodyColor: '#06b6d4',
          borderColor: '#30363d', borderWidth: 1,
          displayColors: false,
          callbacks: { label: c => `${c.raw} new repos indexed` }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(48,54,61,0.4)' },
          ticks: { color:'#8b949e', font:{ family:'JetBrains Mono', size:9 }, stepSize:1 }
        },
        x: {
          grid: { display:false },
          ticks: { color:'#8b949e', font:{ family:'JetBrains Mono', size:9 } }
        }
      }
    }
  });
}

// ============================================================
// SEVERITY DONUT (from NVD intel + current year CVEs)
// ============================================================
function buildSevChart(data) {
  let critical=0, high=0, medium=0, unscored=0;

  (data?.cves || []).forEach(c => {
    const s = nvdLayer?.[c.cve_id]?.s || 0;
    if      (s >= 9.0) critical++;
    else if (s >= 7.0) high++;
    else if (s >= 0.1) medium++;
    else               unscored++;
  });

  const total = (data?.cves||[]).length;
  document.getElementById('sev-total').textContent = total || '—';

  if (sevChart) sevChart.destroy();
  const ctx = document.getElementById('severityChart').getContext('2d');
  sevChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Critical','High','Med/Low','Unscored'],
      datasets: [{
        data: [critical, high, medium, unscored],
        backgroundColor: ['#f85149','#f97316','#d29922','#30363d'],
        borderWidth: 0,
        hoverOffset: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '72%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(22,27,34,0.95)',
          titleColor:'#fff', bodyColor:'#ccc',
          borderColor:'#30363d', borderWidth:1
        }
      }
    }
  });
}
</script>

</body>
</html>
